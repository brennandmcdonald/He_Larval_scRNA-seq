---
title: "TF Analysis"
author: "Brennan McDonald"
date: "2024-04-03"
output: html_document
---

```{r}
library(tidyverse)
library(Seurat)
library(scCustomize)
```


# Generate table with Mfuzz cluster assignments for each gene

```{r}
# need to match the row/gene names from the Mfuzz analysis with the H_ery IDs from the GO annotation dataset

gnames <- anno %>% 
  dplyr::select(H_ery_ID, SPU.common_name) %>% 
  mutate(merge = paste(H_ery_ID, SPU.common_name, sep = ":"))

gnames$new_code <- rep(NA, length(gnames$merge))
i <- 1
for (co in gnames$merge) {
  gnames[i,4] <- paste(str_split_1(co, ":|-|/|_"), collapse = ".")
  i <- i+1
}

df_clusters <- tibble(codes = names(clustered$cluster), 
                      clusters = clustered$cluster)
df_clusters$mem_val <- rep(NA, length(df_clusters$codes))
df_clusters$o_mem_val <- rep(NA, length(df_clusters$codes))
for (g in 1:length(df_clusters$codes)) {
  clust <- as.integer(df_clusters[g, 2])
  p <- clustered$membership[g, clust]
  df_clusters[g, 3] <- p
  df_clusters[g, 4] <- 1-p
}

cluster_inputs <- tibble(GID = gnames$H_ery_ID,
                         code = gnames$new_code)

cluster_inputs <- merge(cluster_inputs, df_clusters, by.x = "code", by.y = "codes")

#write.csv(cluster_inputs, "6-60hr Integrated UMAP/pseudobulk/go_cluster_inputs.csv", 
#          row.names = F)
```

```{r}
mfuzz_genes <- read.csv("6-60hr Integrated UMAP/pseudobulk/go_cluster_inputs.csv")
```


# Search for expression patterns of new transcription factors

Using the list of TFs predicted from GO terms and Hannah's curated TF list

```{r}
tfs <- read.csv("6-60hr Integrated UMAP/pseudobulk/hannah-and-go-term_tf-list.csv")


# generate gene codes to use for lookups in the Mfuzz table and Seurat object
tfs <- tfs %>% 
  mutate(new_gid = str_replace_all(GID, pattern = "_", replace = "-"),
         new_spu_name = str_replace_all(SPU_common_name, 
                                        pattern = "_", 
                                        replace = "-")) %>% 
  mutate(seurat_code = paste(new_gid, new_spu_name, sep = ":")) %>% 
  mutate(mfuzz_code = str_replace_all(seurat_code, pattern = ":|-|/|_", replace = ".")) %>% 
  dplyr::select(-new_gid, -new_spu_name)
```


```{r}
# list of all genes with MFuzz cluster assignments
mfuzz_genes <- read.csv("6-60hr Integrated UMAP/pseudobulk/go_cluster_inputs.csv")
```

Identifies the genes from the TF list that are included in the mfuzz output

```{r}
# An inner_join() only keeps observations from x that have a matching key in y.
mfuzz_tfs <- inner_join(x = as_tibble(mfuzz_genes), y = as_tibble(tfs),
           by = join_by(code == mfuzz_code),
           na_matches = "never") %>% 
  dplyr::select(-GID.y) %>% 
  rename(GID = GID.x)
```

See which TF genes fall into the high early, high middle, and high late categories

```{r}
# sum number of TF genes in each cluster depending on the shape of the expression profile
exp_early <- c(3,5,8)
exp_middle <- c(1,6,7)
exp_late <- c(2,4,9)
mfuzz_tfs$high_expression <- rep(NA, nrow(mfuzz_tfs))
for (i in 1:nrow(mfuzz_tfs)) {
  if (mfuzz_tfs[i,"clusters"] %in% exp_early) {
    mfuzz_tfs[i,"high_expression"] <- "High Early"
  } else if (mfuzz_tfs[i,"clusters"] %in% exp_middle) {
    mfuzz_tfs[i,"high_expression"] <- "High Middle"
  } else if (mfuzz_tfs[i,"clusters"] %in% exp_late) {
    mfuzz_tfs[i,"high_expression"] <- "High Late"
  }
}

#write.csv(mfuzz_tfs, "6-60hr Integrated UMAP/pseudobulk/mfuzz_tfs.csv", row.names = F)

mfuzz_tfs$high_expression <- factor(mfuzz_tfs$high_expression,
                              levels = c("High Early", "High Middle", "High Late"))
```

Plot the number of TFs in each of the time categories

```{r}
mfuzz_tfs %>% 
  filter(!is.na(clusters)) %>% 
  #filter(mem_val > 0.9) %>% 
  group_by(high_expression) %>% 
  summarize(n = n()) %>% 
  ggplot(aes(x = high_expression, y = n)) +
  geom_col(width = 0.4, fill = "darkblue") +
  theme_bw() +
  labs(x = "Time of Highest Expression",
       y = "Number of TF Genes")
```


#################################################################
**Activate the base conda environment for using Seurat**
#################################################################

```{r}
library(tidyverse)
library(Seurat)
```

```{r}
CreateSeuratObject(load(
  file = "6-60hr\ Integrated\ UMAP/HE_6-60hpf_integrated-SCT6k_195dim.Rda", 
                        verbose = T))
```

```{r}
# TFs that were found in the Mfuzz object
mfuzz_tfs <- read_csv("6-60hr Integrated UMAP/pseudobulk/mfuzz_tfs.csv")

# Filter for TFs that have late peaks to their expression
late_tf <- mfuzz_tfs %>% 
  filter(high_expression == "High Late")

mfuzz_tfs %>% 
  group_by(high_expression) %>% 
  summarize(n = n())
```



**This was used for the analysis**

```{r}
# Obtain fold change data for TFs in the following three cell types
types = c("Rudiment Endomesoderm", "Vestibular Ectoderm", "Vegetal Ectoderm")
tfs <- tibble(Gene = c(NA),
              cell_type = c(NA),
              avg_log2FC = c(NA),
              pct.1 = c(NA),
              pct.2 = c(NA))
for (gene in late_tf$seurat_code) {
  for (type in types) {
    fc <- FoldChange(he.integrated, features = gene, ident.1 = type)
    tfs <- add_row(tfs, 
                   Gene = gene,
                   cell_type = type,
                   avg_log2FC = fc[1,1],
                   pct.1 = fc[1,2],
                   pct.2 = fc[1,3])
  }
}
tfs <- tfs[-c(1),]

# Filter for TFs that are strongly restricted to the cell types of interest
useful_tfs <- tfs %>% 
  filter(pct.2 < 0.1) %>% 
  filter(pct.1 > 0.05) %>% 
  filter(avg_log2FC > 0.9) %>% 
  group_by(cell_type) %>% 
  slice_max(n = 50, order_by = avg_log2FC)


#write.csv(useful_tfs, "6-60hr Integrated UMAP/pseudobulk/late-tfs/late-tf_final-list.csv",
#          row.names = F)

tfs <- tfs %>%
  mutate(choose = if_else(avg_log2FC > 0.9 & pct.1 > 0.05 & pct.2 < 0.1, "Select", "No"))

#write.csv(tfs, "6-60hr Integrated UMAP/pseudobulk/late-tfs/late-tf_fold-change.csv", 
#          row.names = F)

sum(tfs[,6] == "Select")
```


```{r}
# Plot all the late stage TFs, and highlight the TFs that meet the selection criteria
tfs <- read_csv("6-60hr Integrated UMAP/pseudobulk/late-tfs/late-tf_fold-change.csv")

tfs %>% 
  ggplot() + 
  geom_point(mapping = aes(x = pct.1, y = pct.2, color = avg_log2FC), size = 0.9) + 
  #scale_color_viridis_c(option = "magma")
  scale_color_gradient(low = "lightblue", high = "darkblue",
                       name = "Average\nLog2(FC)") +
  geom_point(data = tfs[tfs$choose == "Select",], 
             aes(x = pct.1, y = pct.2), color = "red", size = 1.1) +
  theme_bw() +
  geom_line(data = data.frame(x = c(0.05,Inf), y = c(0.1, 0.1)), 
            aes(x = x, y = y), linetype = 2) +
  geom_line(data = data.frame(x = c(0.05,0.05), y = c(-Inf, 0.1)), 
            aes(x = x, y = y), linetype = 2) +
  labs(x = "Percent in Cell Type of Interest",
       y = "Percent in Other Cell Types")
```


```{r}
library(plotly)

plt <- tfs %>% 
  mutate(name = str_split_i(Gene, "Sp-", 2)) %>%
  ggplot(mapping = aes(x = pct.1, y = pct.2, color = avg_log2FC, label = name)) + 
  geom_point(size = 0.9) + 
  geom_text(aes(label=if_else(avg_log2FC>0.9,as.character(name),''))) +
  #scale_color_viridis_c(option = "magma")
  scale_color_gradient(low = "lightblue", high = "darkblue",
                       name = "Average\nLog2(FC)") +
  #geom_point(data = tfs[tfs$choose == "Select",], 
  #           aes(x = pct.1, y = pct.2), color = "red", size = 1.1) +
  theme_bw() +
  #geom_line(data = data.frame(x = c(0.05,Inf), y = c(0.1, 0.1)), 
  #          aes(x = x, y = y), linetype = 2) +
  #geom_line(data = data.frame(x = c(0.05,0.05), y = c(-Inf, 0.1)), 
  #          aes(x = x, y = y), linetype = 2) +
  labs(x = "Percent in Cell Type of Interest",
       y = "Percent in Other Cell Types")

ggplotly(plt)
```




```{r}
useful_tfs <- read_csv("6-60hr Integrated UMAP/pseudobulk/late-tfs/late-tf_final-list.csv")

unique(useful_tfs$Gene)
```



```{r}
keep <- tibble(Gene = c(NA), cluster = c(NA))
clusters <- c("g47", "g32", "g18", "g24", "g25", "g23", "g36", 
              "g12", "g33", "g35", "g45", "g34", "g50", "g55")
for (gene in late_tf$seurat_code) {
  av_ex <- AverageExpression(he.integrated, features = gene, group.by = "seurat_clusters")
  for (clust in clusters) {
    if (av_ex$RNA@x[grep(clust, av_ex$RNA@Dimnames[[2]])] > 2) {
      keep <- add_row(keep, Gene = gene, cluster = clust)
    }
  }
}
keep <- keep[-c(1),]

keep1 <- keep %>% 
  distinct(Gene, .keep_all = T)


late_tf %>% 
  #filter(pct.2 < 0.1) %>% 
  #filter(pct.1 > 0.05) %>% 
  filter(seurat_code %in% keep1$Gene) %>% 
  #filter(avg_log2FC > 0.8) %>% 
  View()
```




